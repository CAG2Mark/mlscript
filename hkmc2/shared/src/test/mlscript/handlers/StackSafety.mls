:js

// sanity check
:expect 5050
fun sum(n) =
  if n == 0 then 0
  else
    n + sum(n - 1)
sum(100)
//│ = 5050

// preserve tail calls
:stackSafe 5
:handler
:expect 0
:sjs
fun hi(n) =
  if n == 0 then 0
  else hi(n - 1)
hi(0)
//│ JS (unsanitized):
//│ let res;
//│ function hi(n) {
//│   let scrut, tmp, diff, scrut1, scrut2, scrut3, tmp1, res1;
//│   function Cont$243(pc1) { return new Cont$243.class(pc1); }
//│   Cont$243.class = class Cont$243 extends globalThis.Predef.__Cont.class {
//│     constructor(pc) {
//│       let tmp2;
//│       tmp2 = super(null, null);
//│       this.pc = pc;
//│     }
//│     resume(value$) {
//│       if (this.pc === 6) {
//│         res1 = value$;
//│       }
//│       contLoop: while (true) {
//│         if (this.pc === 7) {
//│           diff = globalThis.Predef.__stackDepth - globalThis.Predef.__stackOffset;
//│           scrut1 = diff >= 5;
//│           scrut2 = globalThis.Predef.__stackHandler !== undefined;
//│           scrut3 = scrut1 && scrut2;
//│           if (scrut3) {
//│             res1 = globalThis.Predef.__stackHandler.perform();
//│             if (res1 instanceof globalThis.Predef.__EffectSig.class) {
//│               res1.tail.next = this;
//│               this.pc = 6;
//│               return res1;
//│             }
//│             this.pc = 6;
//│             continue contLoop;
//│           }
//│           this.pc = 9;
//│           continue contLoop;
//│         } else if (this.pc === 9) {
//│           scrut = n == 0;
//│           if (scrut) {
//│             return 0;
//│           } else {
//│             tmp = n - 1;
//│             globalThis.Predef.__stackDepth = globalThis.Predef.__stackDepth + 1;
//│             return globalThis.hi(tmp);
//│           }
//│           this.pc = 8;
//│           continue contLoop;
//│         } else if (this.pc === 8) {
//│           break contLoop;
//│         } else if (this.pc === 6) {
//│           tmp1 = res1;
//│           this.pc = 9;
//│           continue contLoop;
//│         }
//│         break;
//│       }
//│     }
//│     toString() { return "Cont$243(" + this.pc + ")"; }
//│   };
//│   diff = globalThis.Predef.__stackDepth - globalThis.Predef.__stackOffset;
//│   scrut1 = diff >= 5;
//│   scrut2 = globalThis.Predef.__stackHandler !== undefined;
//│   scrut3 = scrut1 && scrut2;
//│   if (scrut3) {
//│     res1 = globalThis.Predef.__stackHandler.perform();
//│     if (res1 instanceof globalThis.Predef.__EffectSig.class) {
//│       res1.tail.next = new Cont$243.class(6);
//│       res1.tail = res1.tail.next;
//│       return res1;
//│     }
//│     tmp1 = res1;
//│   }
//│   scrut = n == 0;
//│   if (scrut) {
//│     return 0;
//│   } else {
//│     tmp = n - 1;
//│     globalThis.Predef.__stackDepth = globalThis.Predef.__stackDepth + 1;
//│     return globalThis.hi(tmp);
//│   }
//│ }
//│ function handleBlock$0() {
//│   let stackHandler, res1;
//│   class StackDelay$ extends globalThis.Predef.__StackDelay.class {
//│     constructor() {
//│       let tmp;
//│       tmp = super();
//│     }
//│     perform() {
//│       return globalThis.Predef.__mkEffect(stackHandler, (resume) => {
//│         let res2, curOffset, res3;
//│         function Cont$218(pc1) { return new Cont$218.class(pc1); }
//│         Cont$218.class = class Cont$218 extends globalThis.Predef.__Cont.class {
//│           constructor(pc) {
//│             let tmp;
//│             tmp = super(null, null);
//│             this.pc = pc;
//│           }
//│           resume(value$) {
//│             if (this.pc === 3) {
//│               res3 = value$;
//│             }
//│             contLoop: while (true) {
//│               if (this.pc === 4) {
//│                 curOffset = globalThis.Predef.__stackOffset;
//│                 globalThis.Predef.__stackOffset = globalThis.Predef.__stackDepth;
//│                 res3 = resume();
//│                 if (res3 instanceof globalThis.Predef.__EffectSig.class) {
//│                   res3.tail.next = this;
//│                   this.pc = 3;
//│                   return res3;
//│                 }
//│                 this.pc = 3;
//│                 continue contLoop;
//│               } else if (this.pc === 3) {
//│                 res2 = res3;
//│                 globalThis.Predef.__stackOffset = curOffset;
//│                 return res2;
//│               }
//│               break;
//│             }
//│           }
//│           toString() { return "Cont$218(" + this.pc + ")"; }
//│         };
//│         curOffset = globalThis.Predef.__stackOffset;
//│         globalThis.Predef.__stackOffset = globalThis.Predef.__stackDepth;
//│         res3 = resume();
//│         if (res3 instanceof globalThis.Predef.__EffectSig.class) {
//│           res3.tail.next = new Cont$218.class(3);
//│           res3.tail = res3.tail.next;
//│           return res3;
//│         }
//│         res2 = res3;
//│         globalThis.Predef.__stackOffset = curOffset;
//│         return res2;
//│       });
//│     }
//│     toString() { return "StackDelay$"; }
//│   }
//│   stackHandler = new StackDelay$();
//│   function Cont$194(pc1) { return new Cont$194.class(pc1); }
//│   Cont$194.class = class Cont$194 extends globalThis.Predef.__Cont.class {
//│     constructor(pc) {
//│       let tmp;
//│       tmp = super(null, null);
//│       this.pc = pc;
//│     }
//│     resume(value$) {
//│       if (this.pc === 1) {
//│         res1 = value$;
//│       }
//│       contLoop: while (true) {
//│         if (this.pc === 2) {
//│           globalThis.Predef.__stackDepth = 0;
//│           globalThis.Predef.__stackHandler = stackHandler;
//│           globalThis.Predef.__stackDepth = globalThis.Predef.__stackDepth + 1;
//│           res1 = globalThis.hi(0);
//│           if (res1 instanceof globalThis.Predef.__EffectSig.class) {
//│             res1.tail.next = this;
//│             this.pc = 1;
//│             return res1;
//│           }
//│           this.pc = 1;
//│           continue contLoop;
//│         } else if (this.pc === 1) {
//│           return res1;
//│         }
//│         break;
//│       }
//│     }
//│     toString() { return "Cont$194(" + this.pc + ")"; }
//│   };
//│   globalThis.Predef.__stackDepth = 0;
//│   globalThis.Predef.__stackHandler = stackHandler;
//│   globalThis.Predef.__stackDepth = globalThis.Predef.__stackDepth + 1;
//│   res1 = globalThis.hi(0);
//│   if (res1 instanceof globalThis.Predef.__EffectSig.class) {
//│     res1.tail.next = new Cont$194(1);
//│     return globalThis.Predef.__handleBlockImpl(res1, stackHandler);
//│   }
//│   return res1;
//│ }
//│ res = handleBlock$0();
//│ if (res instanceof this.Predef.__EffectSig.class) {
//│   throw new this.Error("Unhandled effects");
//│ }
//│ this.Predef.__stackDepth = 0;
//│ this.Predef.__stackHandler = undefined;
//│ res
//│ = 0

:sjs
:stackSafe 1000
:handler
:expect 50005000
fun sum(n) =
  if n == 0 then 0
  else
    n + sum(n - 1)
sum(10000)
//│ JS (unsanitized):
//│ let res;
//│ function sum(n) {
//│   let scrut, tmp, tmp1, diff, scrut1, scrut2, scrut3, tmp2, tmp3, res1, res2;
//│   function Cont$488(pc1) { return new Cont$488.class(pc1); }
//│   Cont$488.class = class Cont$488 extends globalThis.Predef.__Cont.class {
//│     constructor(pc) {
//│       let tmp4;
//│       tmp4 = super(null, null);
//│       this.pc = pc;
//│     }
//│     resume(value$) {
//│       if (this.pc === 7) {
//│         res2 = value$;
//│       } else if (this.pc === 6) {
//│         res1 = value$;
//│       }
//│       contLoop: while (true) {
//│         if (this.pc === 8) {
//│           diff = globalThis.Predef.__stackDepth - globalThis.Predef.__stackOffset;
//│           scrut1 = diff >= 1000;
//│           scrut2 = globalThis.Predef.__stackHandler !== undefined;
//│           scrut3 = scrut1 && scrut2;
//│           if (scrut3) {
//│             res1 = globalThis.Predef.__stackHandler.perform();
//│             if (res1 instanceof globalThis.Predef.__EffectSig.class) {
//│               res1.tail.next = this;
//│               this.pc = 6;
//│               return res1;
//│             }
//│             this.pc = 6;
//│             continue contLoop;
//│           }
//│           this.pc = 10;
//│           continue contLoop;
//│         } else if (this.pc === 10) {
//│           scrut = n == 0;
//│           if (scrut) {
//│             return 0;
//│           } else {
//│             tmp = n - 1;
//│             globalThis.Predef.__stackDepth = globalThis.Predef.__stackDepth + 1;
//│             res2 = globalThis.sum(tmp);
//│             if (res2 instanceof globalThis.Predef.__EffectSig.class) {
//│               res2.tail.next = this;
//│               this.pc = 7;
//│               return res2;
//│             }
//│             this.pc = 7;
//│             continue contLoop;
//│           }
//│           this.pc = 9;
//│           continue contLoop;
//│         } else if (this.pc === 9) {
//│           break contLoop;
//│         } else if (this.pc === 7) {
//│           tmp2 = res2;
//│           globalThis.Predef.__stackDepth = globalThis.Predef.__stackDepth - 1;
//│           tmp1 = tmp2;
//│           return n + tmp1;
//│         } else if (this.pc === 6) {
//│           tmp3 = res1;
//│           this.pc = 10;
//│           continue contLoop;
//│         }
//│         break;
//│       }
//│     }
//│     toString() { return "Cont$488(" + this.pc + ")"; }
//│   };
//│   diff = globalThis.Predef.__stackDepth - globalThis.Predef.__stackOffset;
//│   scrut1 = diff >= 1000;
//│   scrut2 = globalThis.Predef.__stackHandler !== undefined;
//│   scrut3 = scrut1 && scrut2;
//│   if (scrut3) {
//│     res1 = globalThis.Predef.__stackHandler.perform();
//│     if (res1 instanceof globalThis.Predef.__EffectSig.class) {
//│       res1.tail.next = new Cont$488.class(6);
//│       res1.tail = res1.tail.next;
//│       return res1;
//│     }
//│     tmp3 = res1;
//│   }
//│   scrut = n == 0;
//│   if (scrut) {
//│     return 0;
//│   } else {
//│     tmp = n - 1;
//│     globalThis.Predef.__stackDepth = globalThis.Predef.__stackDepth + 1;
//│     res2 = globalThis.sum(tmp);
//│     if (res2 instanceof globalThis.Predef.__EffectSig.class) {
//│       res2.tail.next = new Cont$488.class(7);
//│       res2.tail = res2.tail.next;
//│       return res2;
//│     }
//│     tmp2 = res2;
//│     globalThis.Predef.__stackDepth = globalThis.Predef.__stackDepth - 1;
//│     tmp1 = tmp2;
//│     return n + tmp1;
//│   }
//│ }
//│ function handleBlock$0() {
//│   let stackHandler, res1;
//│   class StackDelay$ extends globalThis.Predef.__StackDelay.class {
//│     constructor() {
//│       let tmp;
//│       tmp = super();
//│     }
//│     perform() {
//│       return globalThis.Predef.__mkEffect(stackHandler, (resume) => {
//│         let res2, curOffset, res3;
//│         function Cont$462(pc1) { return new Cont$462.class(pc1); }
//│         Cont$462.class = class Cont$462 extends globalThis.Predef.__Cont.class {
//│           constructor(pc) {
//│             let tmp;
//│             tmp = super(null, null);
//│             this.pc = pc;
//│           }
//│           resume(value$) {
//│             if (this.pc === 3) {
//│               res3 = value$;
//│             }
//│             contLoop: while (true) {
//│               if (this.pc === 4) {
//│                 curOffset = globalThis.Predef.__stackOffset;
//│                 globalThis.Predef.__stackOffset = globalThis.Predef.__stackDepth;
//│                 res3 = resume();
//│                 if (res3 instanceof globalThis.Predef.__EffectSig.class) {
//│                   res3.tail.next = this;
//│                   this.pc = 3;
//│                   return res3;
//│                 }
//│                 this.pc = 3;
//│                 continue contLoop;
//│               } else if (this.pc === 3) {
//│                 res2 = res3;
//│                 globalThis.Predef.__stackOffset = curOffset;
//│                 return res2;
//│               }
//│               break;
//│             }
//│           }
//│           toString() { return "Cont$462(" + this.pc + ")"; }
//│         };
//│         curOffset = globalThis.Predef.__stackOffset;
//│         globalThis.Predef.__stackOffset = globalThis.Predef.__stackDepth;
//│         res3 = resume();
//│         if (res3 instanceof globalThis.Predef.__EffectSig.class) {
//│           res3.tail.next = new Cont$462.class(3);
//│           res3.tail = res3.tail.next;
//│           return res3;
//│         }
//│         res2 = res3;
//│         globalThis.Predef.__stackOffset = curOffset;
//│         return res2;
//│       });
//│     }
//│     toString() { return "StackDelay$"; }
//│   }
//│   stackHandler = new StackDelay$();
//│   function Cont$438(pc1) { return new Cont$438.class(pc1); }
//│   Cont$438.class = class Cont$438 extends globalThis.Predef.__Cont.class {
//│     constructor(pc) {
//│       let tmp;
//│       tmp = super(null, null);
//│       this.pc = pc;
//│     }
//│     resume(value$) {
//│       if (this.pc === 1) {
//│         res1 = value$;
//│       }
//│       contLoop: while (true) {
//│         if (this.pc === 2) {
//│           globalThis.Predef.__stackDepth = 0;
//│           globalThis.Predef.__stackHandler = stackHandler;
//│           globalThis.Predef.__stackDepth = globalThis.Predef.__stackDepth + 1;
//│           res1 = globalThis.sum(10000);
//│           if (res1 instanceof globalThis.Predef.__EffectSig.class) {
//│             res1.tail.next = this;
//│             this.pc = 1;
//│             return res1;
//│           }
//│           this.pc = 1;
//│           continue contLoop;
//│         } else if (this.pc === 1) {
//│           return res1;
//│         }
//│         break;
//│       }
//│     }
//│     toString() { return "Cont$438(" + this.pc + ")"; }
//│   };
//│   globalThis.Predef.__stackDepth = 0;
//│   globalThis.Predef.__stackHandler = stackHandler;
//│   globalThis.Predef.__stackDepth = globalThis.Predef.__stackDepth + 1;
//│   res1 = globalThis.sum(10000);
//│   if (res1 instanceof globalThis.Predef.__EffectSig.class) {
//│     res1.tail.next = new Cont$438(1);
//│     return globalThis.Predef.__handleBlockImpl(res1, stackHandler);
//│   }
//│   return res1;
//│ }
//│ res = handleBlock$0();
//│ if (res instanceof this.Predef.__EffectSig.class) {
//│   throw new this.Error("Unhandled effects");
//│ }
//│ this.Predef.__stackDepth = 0;
//│ this.Predef.__stackHandler = undefined;
//│ res
//│ = 50005000

// stack-overflows without
:re
fun sum(n) =
  if n == 0 then 0
  else
    n + sum(n - 1)
sum(10000)
//│ ═══[RUNTIME ERROR] RangeError: Maximum call stack size exceeded
